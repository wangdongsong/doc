# 01 - 什么是可用性


* 可用性，一般指系统在其能力范围内执行任务的能力。为了正常执行系统功能操作，系统当前可运行的能力。
* 可靠性，一般批系统的质量，一个系统能够按照技术标准持续运行的能力。系统是否具备无差错的执行预期操作的能力。

#### 以下因素导致低可用性

* 资源耗尽， 用户数量增加，导致系统使用的数据量增加，从而可能导致系统资源耗尽，应用程序运行越来越慢并最终无响应。

* 预期之外的压力变化， 应用使用的人越来越多，应用程序的代码修改不足以支撑不断增加的压力，缺乏足够的考虑或计划，因此也增加了问题出现的可能性。

* 流动行为增加， 应用程序高速发展，需要更多开发、测试、设计等其它人员来维护，大量的个体协作会产生大量的流动行为，包括新功能、变更功能、等。这些流动
行为的增加从而增加了相互之间的负面作用的可能。

* 外部依赖， 应用程序依赖的外部资源越多，由于这些资源导致的可用性问题就会越多。

* 技术债务， 应用程序复杂性的增加，通常会导致技术债务（例如未修复的Bug增、未实现的修改等），技术债务会增加可用性问题出现的可能。

# 02 - 提高应用程序可用性的五个要点

> * 时刻考虑应对故障
> * 时刻考虑如何伸缩
> * 缓和风险
> * 监控可用性
> * 以可预期及明确的方式处理可用性问题

### 时刻考虑应对故障

提前为应用程序和服务发生故障而做出计划，假设应用程序发生故障，如何发生？在构建系统时应该在设计和实现的方方面面都考虑可用性，例如：

> * 设计：通过使用一些设计模式，例如捕获底层异常、重试逻辑和断路器，可以帮助我们捕获错误并尽可能避免影响其它功能。<strong>可以限制问题的影响范围，保证核心业务功能</strong>
> * 依赖：依赖组件出现异常，如何处理？重试、断路器，降低依赖故障对你的系统的影响。  
> * 用户：用户参与某项活动导致大量请求增加，流量突然间的增加使用应用程序宕机，能否检测流量突间增加的异常，通过限制请求的速度降低或消除它们的影响。

### 时刻考虑如何伸缩

大多数Web应用程序的流量都在不断增加，在设计及构建系统时，不要只考虑当前的流量，要考虑未来的流量，意味着做以下几点：  

> * 设计出能够增加数据库数量和容量的架构。
> * 考虑限制数据伸缩的原因。设想当数据量达到容易极限时发生什么问题？进一步确认问题并在达到极限之前解决。
> * 应当能够很容易的添加额外的应用服务器，需要仔细考虑在何处和如何维护状态，以及流量如何路由。
> * 静态流量导向离线提供方。系统只需处理动态流量（请求），使用外部的内容分发内容（CDN）不仅降低网络需要处理的流量，也能利用CDN的伸缩效率将静态内容更快地分发给用户。  
> * 考虑是否静态生成一些动态资源，提高程序的可伸缩性。“应用静态的动态资源”，例如：导航栏多数内容是静态的，登录icon及登录后的显示是动态的，采用动静分离，使用CDN分发静态。  

### 缓和风险

保持系统高可用需要消除系统中的风险，首先要确认风险，所有系统中都存在以下风险：

> * 系统崩溃的风险
> * 数据库崩溃的风险
> * 返回结果不正常的风险
> * 网络连接失败的风险
> * 新部署的软件功能出现故障的风险

保持高可用，就需要消除上述风险。但系统越来越复杂时，消除所有风险不可能实现。保持一个大型系统的高可用，更多的是来管理系统的风险。对风险分级，确认风险是什么，哪些可接受，以及能够采取什么措施缓和风险。  

风险管理中的一个部分是风险缓和，指问题发生时，如何去尽可能降低问题所带来的影响。缓和意味着即使服务不可用时，依然尽可能确保系统以最好、最完整的状态工作。

例如：应用程序Down之后会404提示，之前若网页不存在，直接提示404或500，现在百度或其它网站直接给出相关性的内容提示用户。A依赖B，若B服务宕机后，A能否给出相应提示，让用户转去别的服务。

### 监控可用性

应该确保对应用程序进行适当监控，以便可以从外部和内部两个视角视察应用程序的运行状况。监控的程序取决于应用程序的特点和要求，但通常具备以下监控。  

> * 服务器监控：监控服务器的健康状况，并且确保它们始终有效运行。
> * 配置变化监控：监控系统的配置变化，以便确定它们对应用程序的影响。
> * 应用程序性能监控：深入了解应用程序和服务，确保它们按照预期进行。
> * 人为测试：从用户的角度来实时检测应用程序的运行情况，以便在用户真正发现问题之前发现它们。
> * 报警：问题发生时通知相关人员，以使问题快速有效得到解决，将对用户的影响降低到最小。  

### 以预测及明确的方式来处理可用性问题

> * 报警发送给服务负责人及依赖的团队，且在收到报警后采取行动。
> * 建立整个团队都遵循的帮助诊断及修复常见故障问题的流程。
> * 标准化的流程和办法写进操作手机，团队中人手一份，写明简单问题如何处理，以及当无法使用手机解决问题时需要上报问题的联系人列表。

总而言之，没人能够预测到可用性问题何时何地发生，但可以假设它们会发生的可能性场景，针对不同场景提前做好处理可用性问题的准备，是降低问题出现概率和严重性的最佳办法。

# 03 - 测量可用性

测量可用性对保证系统高可用非常重要，对于Web应用程序的可用性来说，常用的测量方法是计算用户访问的时间百分比，通过以下公式来计算一段时间内的可用性：

网站可用性百分比 = (该期间的总秒数 - 系统宕机的秒数) / 该期间的总秒数

### N个9

通常使用“N个9”来形容可用性，这是表示高可用性百分比的一个简化方式，表格如下：

| N 个 9 | 百分比 | 每月的故障时间 |
|--------|--------|--------------|
| 2 个 9 | 99%    | 432分种      |
| 3 个 9 | 99.9%  | 43分种      |
| 4 个 9 | 99.99%  | 4分种      |
| 5 个 9 | 99.999% | 26秒      |
| 6 个 9 | 99.9999%| 2.6秒     |

**备注：** 假设每个月有30天，每月共计432,000秒

### 合理的可用性

对于系统的可用性数值无唯一答案，该值取决于网站要求、用户期望、业务需要及业务期望。通常对于简单的Web应用来说，3个9的高可用性是可接受的。对于一个要求较高的Web应用程序，一般会采用5个9。

计划中和日常维护工作所导致的系统不可用时间也要计算在可用性百分比之中。因为计划中的维护和未预期的故障效果其实差不多，用户希望程序是可用的。但是若不可用，则用户的就会有负面的体验。

# 04 - 提高下降的可用性

### 测试并跟踪当前可用性

* 测量可用性。
* 监管可用性并定期收集结果。
* 服务分级
* 风险模型

### 手动流程自动化

为维护高可用性，需要移除未知及不可控因素，而执行手动操作是常见的为系统带来不可控和未知结果的因素。事实证明，自动化执行更改可以保持系统和应用程序的稳定性。这其中包括服务器配置更改、性能调优、重启服务器、重启服务、改变路由规则，以及升级和部署软件包。

* 自动化部署
* 配置管理
* 更改实验和高频次更改

通过自动化的配置管理流程，做到以下几点：

* 文档记录想要进行的更改。
* 让经验丰富的人来审查本次变更，可以提出建议和改进。
* 在一个测试或预发布环境上进行测试。
* 快速、简单地部署更改内容。
* 快速检查结果。如果本次变更没有达到想要的结果，可以快速回滚到上一次正常状态。

**备注**：实现这一流程的关键是，拥有一个具有回滚能力的自动变更流程，以及对系统频繁、轻易进行小范围更改的能力。前者可以对多台服务器统一修改，后者可以让你对更改的内容进行实验，并且在失败的时候进行回滚，让用户几乎感觉不到。

